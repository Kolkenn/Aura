<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>CycleTrack MVP</title>

    <!-- PWA Config -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Noto Sans", "sans-serif"] },
            colors: {
              brand: {
                50: "#fff1f2",
                100: "#ffe4e6",
                200: "#fecdd3",
                300: "#fda4af",
                400: "#fb7185",
                500: "#f43f5e",
                600: "#e11d48",
                900: "#881337",
              },
              neutral: {
                50: "#fafaf9",
                100: "#f5f5f4",
                200: "#e7e5e4",
                500: "#78716c",
                800: "#292524",
              },
            },
          },
        },
      };
    </script>

    <style>
      body {
        background-color: #f5f5f4;
        color: #292524;
        -webkit-tap-highlight-color: transparent;
      }
      .chart-container {
        position: relative;
        width: 100%;
        max-width: 600px;
        margin: 0 auto;
        height: 300px;
        max-height: 400px;
      }
      @media (min-width: 768px) {
        .chart-container {
          height: 350px;
        }
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body class="font-sans antialiased h-screen flex flex-col overflow-hidden">
    <!-- Header -->
    <header
      class="bg-white border-b border-neutral-200 px-4 py-3 flex justify-between items-center shadow-sm z-10 pt-safe-top"
    >
      <div class="flex items-center gap-2">
        <span class="text-2xl">üå∏</span>
        <h1 class="text-lg font-bold text-neutral-800 tracking-tight">
          CycleTrack
        </h1>
      </div>

      <div class="flex items-center gap-2">
        <!-- Install Button (Hidden by default, shown via JS) -->
        <button
          id="install-btn"
          class="hidden text-xs font-bold text-white bg-brand-500 px-3 py-1.5 rounded-full shadow-sm hover:bg-brand-600 transition-colors flex items-center gap-1"
        >
          <span>‚¨á</span> Install
        </button>

        <div
          id="status-indicator"
          class="text-xs font-medium text-brand-600 bg-brand-50 px-3 py-1 rounded-full"
        >
          Loading...
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <main
      id="main-container"
      class="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-24 relative scroll-smooth"
    >
      <!-- VIEW 1: PROTOTYPE -->
      <div id="view-prototype" class="space-y-6">
        <div class="bg-white rounded-2xl shadow-sm p-4">
          <div class="flex justify-between items-center mb-4">
            <button
              id="prev-month"
              class="p-2 hover:bg-neutral-100 rounded-full text-neutral-600 text-xl"
            >
              ‚Äπ
            </button>
            <h2
              id="current-month-label"
              class="text-lg font-semibold text-neutral-800"
            >
              October 2023
            </h2>
            <button
              id="next-month"
              class="p-2 hover:bg-neutral-100 rounded-full text-neutral-600 text-xl"
            >
              ‚Ä∫
            </button>
          </div>

          <div class="grid grid-cols-7 gap-1 mb-2 text-center">
            <div class="text-xs font-medium text-neutral-400">S</div>
            <div class="text-xs font-medium text-neutral-400">M</div>
            <div class="text-xs font-medium text-neutral-400">T</div>
            <div class="text-xs font-medium text-neutral-400">W</div>
            <div class="text-xs font-medium text-neutral-400">T</div>
            <div class="text-xs font-medium text-neutral-400">F</div>
            <div class="text-xs font-medium text-neutral-400">S</div>
          </div>

          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>

          <div class="mt-4 flex gap-4 justify-center text-xs text-neutral-500">
            <div class="flex items-center gap-1">
              <span class="w-3 h-3 rounded-full bg-brand-500"></span> Period
            </div>
            <div class="flex items-center gap-1">
              <span
                class="w-3 h-3 rounded-full bg-brand-200 border border-brand-300 border-dashed"
              ></span>
              Predicted
            </div>
            <div class="flex items-center gap-1">
              <span class="w-3 h-3 rounded-full bg-neutral-200"></span> Today
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-5">
          <h3
            class="font-semibold text-neutral-800 mb-4 flex items-center gap-2"
          >
            <span>üìä</span> Cycle Trends
          </h3>
          <div class="chart-container"><canvas id="cycleChart"></canvas></div>
          <p class="text-xs text-center text-neutral-400 mt-2">
            Based on last 6 months of data
          </p>
        </div>
      </div>

      <!-- VIEW 2: BLUEPRINT -->
      <div id="view-blueprint" class="hidden space-y-6">
        <div class="bg-brand-50 border border-brand-100 p-4 rounded-xl">
          <h2 class="text-lg font-bold text-brand-900 mb-2">PWA Status</h2>
          <p class="text-sm text-brand-800 leading-relaxed">
            This app is now configured for Android installation. If you see the
            "Install" button in the header, tap it to add to home screen. This
            removes the browser bar.
          </p>
        </div>
      </div>

      <!-- VIEW 3: SETTINGS -->
      <div id="view-settings" class="hidden space-y-6">
        <div class="bg-white rounded-xl shadow-sm p-4 space-y-4">
          <h3 class="font-bold text-neutral-800 mb-2">Data Management</h3>
          <button
            onclick="app.exportData()"
            class="w-full flex items-center justify-between p-3 bg-brand-50 hover:bg-brand-100 text-brand-700 rounded-lg transition-colors"
          >
            <span class="flex items-center gap-2"
              ><span>üì•</span> Export Backup (JSON)</span
            ><span class="text-lg">‚Ä∫</span>
          </button>
          <div class="relative w-full">
            <input
              type="file"
              id="importFile"
              class="hidden"
              accept=".json"
              onchange="app.importData(this)"
            />
            <button
              onclick="document.getElementById('importFile').click()"
              class="w-full flex items-center justify-between p-3 bg-neutral-50 hover:bg-neutral-100 text-neutral-700 rounded-lg transition-colors"
            >
              <span class="flex items-center gap-2"
                ><span>üì§</span> Import Backup</span
              ><span class="text-lg">‚Ä∫</span>
            </button>
          </div>
          <hr class="border-neutral-100" />
          <button
            onclick="app.clearData()"
            class="w-full flex items-center justify-between p-3 bg-white border border-red-100 hover:bg-red-50 text-red-600 rounded-lg transition-colors"
          >
            <span class="flex items-center gap-2"
              ><span>üóëÔ∏è</span> Clear All Data</span
            >
          </button>
        </div>
        <div class="bg-neutral-800 rounded-xl shadow-sm p-4">
          <h3
            class="font-bold text-neutral-200 mb-2 text-xs uppercase tracking-wider"
          >
            Current Data Structure
          </h3>
          <pre
            id="json-viewer"
            class="text-xs text-green-400 font-mono overflow-x-auto p-2 bg-neutral-900 rounded-lg"
          ></pre>
        </div>
      </div>
    </main>

    <!-- Logging Modal -->
    <div
      id="log-modal"
      class="fixed inset-0 bg-neutral-900/50 z-50 hidden flex items-end sm:items-center sm:justify-center backdrop-blur-sm transition-opacity opacity-0 pointer-events-none"
    >
      <div
        class="bg-white w-full sm:w-96 sm:rounded-2xl rounded-t-2xl shadow-2xl transform transition-transform translate-y-full sm:translate-y-0 p-5 max-h-[90vh] overflow-y-auto"
      >
        <div class="flex justify-between items-center mb-6">
          <div>
            <h2 class="text-xl font-bold text-neutral-800">Log Entry</h2>
            <p id="modal-date-label" class="text-sm text-neutral-500">Today</p>
          </div>
          <button
            onclick="app.closeModal()"
            class="w-8 h-8 rounded-full bg-neutral-100 text-neutral-500 flex items-center justify-center"
          >
            ‚úï
          </button>
        </div>
        <div class="space-y-6">
          <div class="space-y-2">
            <label
              class="text-xs font-bold text-neutral-500 uppercase tracking-wide"
              >Flow Intensity</label
            >
            <div class="grid grid-cols-4 gap-2">
              <button
                class="flow-btn p-2 rounded-lg border border-neutral-200 text-center text-sm hover:bg-brand-50 focus:ring-2 focus:ring-brand-500"
                data-value="spotting"
              >
                <span class="block text-lg mb-1">üíß</span>Spot
              </button>
              <button
                class="flow-btn p-2 rounded-lg border border-neutral-200 text-center text-sm hover:bg-brand-50 focus:ring-2 focus:ring-brand-500"
                data-value="light"
              >
                <span class="block text-lg mb-1">üíßüíß</span>Light
              </button>
              <button
                class="flow-btn p-2 rounded-lg border border-neutral-200 text-center text-sm hover:bg-brand-50 focus:ring-2 focus:ring-brand-500"
                data-value="medium"
              >
                <span class="block text-lg mb-1">ü©∏</span>Med
              </button>
              <button
                class="flow-btn p-2 rounded-lg border border-neutral-200 text-center text-sm hover:bg-brand-50 focus:ring-2 focus:ring-brand-500"
                data-value="heavy"
              >
                <span class="block text-lg mb-1">üåä</span>Heavy
              </button>
            </div>
          </div>
          <div class="space-y-2">
            <label
              class="text-xs font-bold text-neutral-500 uppercase tracking-wide"
              >Mood</label
            >
            <div class="flex justify-between bg-neutral-50 p-2 rounded-xl">
              <button
                class="mood-btn text-2xl p-2 rounded-full hover:bg-white opacity-50"
                data-value="happy"
              >
                üòä
              </button>
              <button
                class="mood-btn text-2xl p-2 rounded-full hover:bg-white opacity-50"
                data-value="neutral"
              >
                üòê
              </button>
              <button
                class="mood-btn text-2xl p-2 rounded-full hover:bg-white opacity-50"
                data-value="sad"
              >
                üò¢
              </button>
              <button
                class="mood-btn text-2xl p-2 rounded-full hover:bg-white opacity-50"
                data-value="irritable"
              >
                üò†
              </button>
              <button
                class="mood-btn text-2xl p-2 rounded-full hover:bg-white opacity-50"
                data-value="tired"
              >
                üò¥
              </button>
            </div>
          </div>
          <div class="space-y-2">
            <label
              class="text-xs font-bold text-neutral-500 uppercase tracking-wide"
              >Symptoms</label
            >
            <div class="flex flex-wrap gap-2" id="symptom-chips"></div>
          </div>
          <button
            onclick="app.saveEntry()"
            class="w-full py-3 bg-brand-500 text-white rounded-xl font-bold shadow-md"
          >
            Save Entry
          </button>
          <button
            onclick="app.deleteEntry()"
            class="w-full py-2 text-red-400 text-sm hover:text-red-600"
          >
            Delete Entry
          </button>
        </div>
      </div>
    </div>

    <!-- Bottom Navigation -->
    <nav
      class="fixed bottom-0 left-0 w-full bg-white border-t border-neutral-200 pb-safe z-40"
    >
      <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
        <button
          class="nav-btn active flex flex-col items-center justify-center w-full h-full text-brand-500"
          data-target="view-prototype"
        >
          <span class="text-2xl mb-0.5">üìÖ</span
          ><span class="text-[10px] font-medium">Tracker</span>
        </button>
        <button
          class="nav-btn flex flex-col items-center justify-center w-full h-full text-neutral-400"
          data-target="view-blueprint"
        >
          <span class="text-2xl mb-0.5">üìã</span
          ><span class="text-[10px] font-medium">Status</span>
        </button>
        <button
          class="nav-btn flex flex-col items-center justify-center w-full h-full text-neutral-400"
          data-target="view-settings"
        >
          <span class="text-2xl mb-0.5">‚öôÔ∏è</span
          ><span class="text-[10px] font-medium">Data</span>
        </button>
      </div>
    </nav>

    <script>
      // PWA INSTALL LOGIC
      let deferredPrompt;
      const installBtn = document.getElementById("install-btn");

      // 1. Listen for the browser install event
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        // Show the install button
        installBtn.classList.remove("hidden");
      });

      // 2. Handle click
      installBtn.addEventListener("click", async () => {
        if (!deferredPrompt) return;
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        installBtn.classList.add("hidden");
      });

      // 3. Register Service Worker (REQUIRED for Android Install)
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("sw.js")
            .then((reg) => console.log("SW registered"))
            .catch((err) => console.log("SW failed", err));
        });
      }

      // APP LOGIC
      const app = {
        data: {
          userSettings: {
            averageCycleLength: 28,
            customSymptoms: [
              "Cramps",
              "Headache",
              "Bloating",
              "Acne",
              "Cravings",
              "Backache",
            ],
          },
          entries: {},
        },
        state: {
          currentDate: new Date(),
          selectedDateStr: null,
          view: "view-prototype",
        },
        chartInstance: null,

        init() {
          const saved = localStorage.getItem("cycle_tracker_mvp_data");
          if (saved)
            try {
              this.data = JSON.parse(saved);
            } catch (e) {}

          document
            .querySelectorAll(".nav-btn")
            .forEach((btn) =>
              btn.addEventListener("click", (e) =>
                this.switchView(e.currentTarget.dataset.target, e.currentTarget)
              )
            );
          document
            .getElementById("prev-month")
            .addEventListener("click", () => {
              this.state.currentDate.setMonth(
                this.state.currentDate.getMonth() - 1
              );
              this.renderCalendar();
            });
          document
            .getElementById("next-month")
            .addEventListener("click", () => {
              this.state.currentDate.setMonth(
                this.state.currentDate.getMonth() + 1
              );
              this.renderCalendar();
            });

          this.renderSymptomChips();
          this.setupFlowListeners();
          this.renderCalendar();
          this.updateStats();
          this.renderJSONViewer();
        },

        switchView(viewId, btn) {
          ["view-prototype", "view-blueprint", "view-settings"].forEach((id) =>
            document.getElementById(id).classList.add("hidden")
          );
          document.getElementById(viewId).classList.remove("hidden");
          document.querySelectorAll(".nav-btn").forEach((b) => {
            b.classList.remove("text-brand-500");
            b.classList.add("text-neutral-400");
          });
          btn.classList.remove("text-neutral-400");
          btn.classList.add("text-brand-500");
          if (viewId === "view-settings") this.renderJSONViewer();
          if (viewId === "view-prototype") this.updateStats();
        },

        saveData() {
          localStorage.setItem(
            "cycle_tracker_mvp_data",
            JSON.stringify(this.data)
          );
          this.renderJSONViewer();
        },

        renderCalendar() {
          const grid = document.getElementById("calendar-grid");
          grid.innerHTML = "";
          const year = this.state.currentDate.getFullYear();
          const month = this.state.currentDate.getMonth();
          const monthNames = [
            "January",
            "February",
            "March",
            "April",
            "May",
            "June",
            "July",
            "August",
            "September",
            "October",
            "November",
            "December",
          ];
          document.getElementById(
            "current-month-label"
          ).textContent = `${monthNames[month]} ${year}`;
          const firstDay = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          const predictions = this.calculatePredictions();
          const todayStr = new Date().toISOString().split("T")[0];

          for (let i = 0; i < firstDay; i++)
            grid.appendChild(document.createElement("div"));

          for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${String(month + 1).padStart(
              2,
              "0"
            )}-${String(d).padStart(2, "0")}`;
            const entry = this.data.entries[dateStr];
            const isToday = dateStr === todayStr;
            const dayEl = document.createElement("div");
            dayEl.className = `aspect-square rounded-full flex flex-col items-center justify-center text-sm cursor-pointer relative hover:bg-neutral-100 transition-colors ${
              isToday
                ? "bg-neutral-100 font-bold border border-neutral-300"
                : ""
            }`;
            dayEl.onclick = () => this.openLog(dateStr);
            dayEl.innerHTML = `<span class="z-10">${d}</span>`;

            if (entry && entry.flow) {
              dayEl.classList.add(
                "bg-brand-500",
                "text-white",
                "hover:bg-brand-600"
              );
              if (isToday)
                dayEl.classList.remove("bg-neutral-100", "text-neutral-800");
            } else if (predictions.includes(dateStr)) {
              dayEl.classList.add(
                "bg-brand-50",
                "text-brand-800",
                "border",
                "border-brand-200",
                "border-dashed"
              );
            }
            if (entry && entry.mood)
              dayEl.innerHTML += `<span class="absolute bottom-1 w-1 h-1 rounded-full bg-yellow-400"></span>`;
            grid.appendChild(dayEl);
          }
        },

        calculatePredictions() {
          const dates = Object.keys(this.data.entries).sort();
          const starts = [];
          let lastDate = null;
          dates.forEach((d) => {
            const entry = this.data.entries[d];
            if (!entry.flow) return;
            const dateObj = new Date(d);
            if (!lastDate || (dateObj - lastDate) / (1000 * 60 * 60 * 24) > 10)
              starts.push(d);
            lastDate = dateObj;
          });
          if (starts.length === 0) return [];

          let totalDiff = 0,
            count = 0;
          if (starts.length >= 2) {
            for (let i = 1; i < starts.length; i++) {
              const diff =
                (new Date(starts[i]) - new Date(starts[i - 1])) /
                (1000 * 60 * 60 * 24);
              if (diff < 40 && diff > 20) {
                totalDiff += diff;
                count++;
              }
            }
          }
          const avg =
            count > 0
              ? Math.round(totalDiff / count)
              : this.data.userSettings.averageCycleLength;
          const lastStart = new Date(starts[starts.length - 1]);
          const nextStart = new Date(lastStart);
          nextStart.setDate(lastStart.getDate() + avg);
          const predictionDates = [];
          for (let i = 0; i < 5; i++) {
            const pDate = new Date(nextStart);
            pDate.setDate(nextStart.getDate() + i);
            predictionDates.push(pDate.toISOString().split("T")[0]);
          }

          const daysUntil = Math.ceil(
            (nextStart - new Date()) / (1000 * 60 * 60 * 24)
          );
          const statusEl = document.getElementById("status-indicator");
          if (daysUntil > 0)
            statusEl.textContent = `Period in ~${daysUntil} days`;
          else if (daysUntil > -7 && daysUntil <= 0)
            statusEl.textContent = "Period likely now";
          else statusEl.textContent = "Log to see predictions";
          return predictionDates;
        },

        openLog(dateStr) {
          this.state.selectedDateStr = dateStr;
          const modal = document.getElementById("log-modal");
          const entry = this.data.entries[dateStr] || {};
          document.getElementById("modal-date-label").textContent = new Date(
            dateStr
          ).toDateString();

          document.querySelectorAll(".flow-btn").forEach((b) => {
            b.classList.remove(
              "ring-2",
              "ring-brand-500",
              "border-brand-500",
              "bg-brand-50"
            );
            if (b.dataset.value === entry.flow)
              b.classList.add(
                "ring-2",
                "ring-brand-500",
                "border-brand-500",
                "bg-brand-50"
              );
          });
          document.querySelectorAll(".mood-btn").forEach((b) => {
            b.classList.remove("opacity-100", "bg-white", "shadow-sm");
            b.classList.add("opacity-50");
            if (b.dataset.value === entry.mood) {
              b.classList.remove("opacity-50");
              b.classList.add("opacity-100", "bg-white", "shadow-sm");
            }
          });
          document.querySelectorAll(".symptom-chip").forEach((c) => {
            c.classList.remove("bg-neutral-800", "text-white");
            c.classList.add("bg-neutral-100", "text-neutral-600");
            if (entry.symptoms && entry.symptoms.includes(c.dataset.value)) {
              c.classList.remove("bg-neutral-100", "text-neutral-600");
              c.classList.add("bg-neutral-800", "text-white");
            }
          });
          modal.classList.remove("hidden", "pointer-events-none");
          setTimeout(() => modal.classList.remove("opacity-0"), 10);
        },

        closeModal() {
          const modal = document.getElementById("log-modal");
          modal.classList.add("opacity-0");
          setTimeout(
            () => modal.classList.add("hidden", "pointer-events-none"),
            300
          );
        },

        saveEntry() {
          const flow =
            document.querySelector(".flow-btn.ring-2")?.dataset.value || null;
          const mood =
            document.querySelector(".mood-btn.opacity-100")?.dataset.value ||
            null;
          const symptoms = Array.from(
            document.querySelectorAll(".symptom-chip.bg-neutral-800")
          ).map((c) => c.dataset.value);
          if (!flow && !mood && symptoms.length === 0)
            delete this.data.entries[this.state.selectedDateStr];
          else
            this.data.entries[this.state.selectedDateStr] = {
              flow,
              mood,
              symptoms,
            };
          this.saveData();
          this.closeModal();
          this.renderCalendar();
          this.updateStats();
        },

        deleteEntry() {
          delete this.data.entries[this.state.selectedDateStr];
          this.saveData();
          this.closeModal();
          this.renderCalendar();
          this.updateStats();
        },

        renderSymptomChips() {
          const container = document.getElementById("symptom-chips");
          container.innerHTML = "";
          this.data.userSettings.customSymptoms.forEach((sym) => {
            const btn = document.createElement("button");
            btn.className =
              "symptom-chip px-3 py-1.5 rounded-full text-xs font-medium bg-neutral-100 text-neutral-600 transition-colors border border-transparent";
            btn.textContent = sym;
            btn.dataset.value = sym;
            btn.onclick = () => {
              if (btn.classList.contains("bg-neutral-800")) {
                btn.classList.remove("bg-neutral-800", "text-white");
                btn.classList.add("bg-neutral-100", "text-neutral-600");
              } else {
                btn.classList.remove("bg-neutral-100", "text-neutral-600");
                btn.classList.add("bg-neutral-800", "text-white");
              }
            };
            container.appendChild(btn);
          });
        },

        setupFlowListeners() {
          document.querySelectorAll(".flow-btn").forEach(
            (btn) =>
              (btn.onclick = () => {
                document
                  .querySelectorAll(".flow-btn")
                  .forEach((b) =>
                    b.classList.remove(
                      "ring-2",
                      "ring-brand-500",
                      "border-brand-500",
                      "bg-brand-50"
                    )
                  );
                btn.classList.add(
                  "ring-2",
                  "ring-brand-500",
                  "border-brand-500",
                  "bg-brand-50"
                );
              })
          );
          document.querySelectorAll(".mood-btn").forEach(
            (btn) =>
              (btn.onclick = () => {
                document.querySelectorAll(".mood-btn").forEach((b) => {
                  b.classList.remove("opacity-100", "bg-white", "shadow-sm");
                  b.classList.add("opacity-50");
                });
                btn.classList.remove("opacity-50");
                btn.classList.add("opacity-100", "bg-white", "shadow-sm");
              })
          );
        },

        updateStats() {
          const dates = Object.keys(this.data.entries).sort();
          const starts = [];
          let lastDate = null;
          dates.forEach((d) => {
            const entry = this.data.entries[d];
            if (!entry.flow) return;
            const dateObj = new Date(d);
            if (!lastDate || (dateObj - lastDate) / (1000 * 60 * 60 * 24) > 10)
              starts.push(d);
            lastDate = dateObj;
          });
          const lengths = [],
            labels = [];
          if (starts.length >= 2) {
            for (let i = 1; i < starts.length; i++) {
              const diff = Math.round(
                (new Date(starts[i]) - new Date(starts[i - 1])) /
                  (1000 * 60 * 60 * 24)
              );
              if (diff < 50) {
                lengths.push(diff);
                labels.push(
                  new Date(starts[i - 1]).toLocaleString("default", {
                    month: "short",
                  })
                );
              }
            }
          }
          const ctx = document.getElementById("cycleChart").getContext("2d");
          if (this.chartInstance) this.chartInstance.destroy();
          this.chartInstance = new Chart(ctx, {
            type: "bar",
            data: {
              labels: lengths.length ? labels : ["No Data"],
              datasets: [
                {
                  label: "Days",
                  data: lengths.length ? lengths : [28],
                  backgroundColor: "#fb7185",
                  borderRadius: 6,
                  maxBarThickness: 40,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                y: { display: false },
                x: { grid: { display: false } },
              },
            },
          });
        },

        renderJSONViewer() {
          document.getElementById("json-viewer").textContent = JSON.stringify(
            this.data,
            null,
            2
          );
        },
        exportData() {
          const dataStr =
            "data:text/json;charset=utf-8," +
            encodeURIComponent(JSON.stringify(this.data));
          const a = document.createElement("a");
          a.href = dataStr;
          a.download = "backup.json";
          document.body.appendChild(a);
          a.click();
          a.remove();
        },
        importData(input) {
          const file = input.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              this.data = JSON.parse(e.target.result);
              this.saveData();
              this.init();
              alert("Imported!");
            } catch (err) {
              alert("Error");
            }
          };
          reader.readAsText(file);
        },
        clearData() {
          if (confirm("Delete all history?")) {
            this.data.entries = {};
            this.saveData();
            this.init();
          }
        },
      };
      app.init();
    </script>
  </body>
</html>
