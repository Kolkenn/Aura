<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura - Cycle Tracker</title>
    
    <!-- PWA: iOS Config (Hides Safari UI) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default"> <!-- Options: default, black, black-translucent -->
    <meta name="apple-mobile-web-app-title" content="CycleTrack">

    <!-- PWA: Android/Chrome Config (Hides Chrome UI) -->
    <meta name="theme-color" content="#ffffff">
    <!-- Embedded Manifest via Data URI to keep this a single file -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"CycleTrack MVP","short_name":"CycleTrack","display":"standalone","start_url":".","background_color":"#f5f5f4","theme_color":"#ffffff","icons":[{"src":"https://api.iconify.design/noto:blossom.svg","sizes":"192x192","type":"image/svg+xml"}]}'>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Noto Sans for clean, modern readability -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chosen Palette: Serene Rose - Warm neutrals (Stone) mixed with soft Rose for the primary action color. 
         Designed to be calming and private. Background is always light/warm white. -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#fff1f2',
                            100: '#ffe4e6',
                            200: '#fecdd3',
                            300: '#fda4af',
                            400: '#fb7185',
                            500: '#f43f5e', // Primary Action
                            600: '#e11d48',
                            900: '#881337',
                        },
                        neutral: {
                            50: '#fafaf9',
                            100: '#f5f5f4', // Main BG
                            200: '#e7e5e4',
                            500: '#78716c',
                            800: '#292524', // Text
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Reset */
        body {
            background-color: #f5f5f4; /* neutral-100 */
            color: #292524; /* neutral-800 */
            -webkit-tap-highlight-color: transparent;
        }

        /* Chart Container Styling - Mandatory Requirement */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* max-w-xl equivalent */
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Utility */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Smooth transitions for interactive elements */
        .interactive-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .interactive-card:active {
            transform: scale(0.98);
        }
    </style>

    <!-- Application Structure Plan: 
         The app is structured as a Single Page App (SPA) with a fixed bottom navigation, mimicking a native mobile experience.
         
         1. **Views**: 
            - "Prototype": The actual functional calendar and logging tool (Must Haves).
            - "Blueprint": An interactive breakdown of the Specification (Architecture, Roadmap, Scope).
            - "Data & Settings": Management of LocalStorage and Import/Export (Should Haves).
         
         2. **Flow**: 
            - Users land on the "Prototype" to immediately test the core value.
            - "Log Data" is a modal overlay for focus.
            - "Blueprint" allows the developer (you) to review the requirements against the built features.
         
         3. **Why this structure**: 
            - It serves the dual purpose of being a useful tool for your wife AND a reference document for you.
            - Mobile-first bottom nav is standard for this domain (easy thumb access).
    -->
</head>
<body class="font-sans antialiased h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-neutral-200 px-4 py-3 flex justify-between items-center shadow-sm z-10 pt-safe-top">
        <div class="flex items-center gap-2">
            <span class="text-2xl">üå∏</span>
            <h1 class="text-lg font-bold text-neutral-800 tracking-tight">CycleTrack <span class="text-xs font-normal text-neutral-500 bg-neutral-100 px-2 py-0.5 rounded-full">MVP</span></h1>
        </div>
        <div id="status-indicator" class="text-xs font-medium text-brand-600 bg-brand-50 px-3 py-1 rounded-full">
            Loading...
        </div>
    </header>

    <!-- Main Content Area (Scrollable) -->
    <main id="main-container" class="flex-1 overflow-y-auto overflow-x-hidden p-4 pb-24 relative scroll-smooth">
        
        <!-- VIEW 1: PROTOTYPE (The Functional App) -->
        <div id="view-prototype" class="space-y-6">
            
            <!-- Intro Paragraph for Prototype -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-neutral-100">
                <p class="text-sm text-neutral-600 leading-relaxed">
                    <strong>Live MVP Demo:</strong> This section implements the "Must Have" requirements from Section 3 of the specification. It uses <code>localStorage</code> for persistence and basic algorithms for prediction. Tap any date to log flow, mood, or symptoms.
                </p>
            </div>

            <!-- Calendar Component -->
            <div class="bg-white rounded-2xl shadow-sm p-4">
                <div class="flex justify-between items-center mb-4">
                    <button id="prev-month" class="p-2 hover:bg-neutral-100 rounded-full text-neutral-600 text-xl">‚Äπ</button>
                    <h2 id="current-month-label" class="text-lg font-semibold text-neutral-800">October 2023</h2>
                    <button id="next-month" class="p-2 hover:bg-neutral-100 rounded-full text-neutral-600 text-xl">‚Ä∫</button>
                </div>
                
                <!-- Day Names -->
                <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                    <div class="text-xs font-medium text-neutral-400">S</div>
                    <div class="text-xs font-medium text-neutral-400">M</div>
                    <div class="text-xs font-medium text-neutral-400">T</div>
                    <div class="text-xs font-medium text-neutral-400">W</div>
                    <div class="text-xs font-medium text-neutral-400">T</div>
                    <div class="text-xs font-medium text-neutral-400">F</div>
                    <div class="text-xs font-medium text-neutral-400">S</div>
                </div>

                <!-- Calendar Grid -->
                <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                    <!-- Javascript will populate this -->
                </div>
                
                <div class="mt-4 flex gap-4 justify-center text-xs text-neutral-500">
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-brand-500"></span> Period</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-brand-200 border border-brand-300 border-dashed"></span> Predicted</div>
                    <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-neutral-200"></span> Today</div>
                </div>
            </div>

            <!-- Stats / Quick Insights -->
            <div class="bg-white rounded-2xl shadow-sm p-5">
                <h3 class="font-semibold text-neutral-800 mb-4 flex items-center gap-2">
                    <span>üìä</span> Cycle Trends
                </h3>
                <div class="chart-container">
                    <canvas id="cycleChart"></canvas>
                </div>
                <p class="text-xs text-center text-neutral-400 mt-2">Based on last 6 months of data</p>
            </div>

            <!-- Visualization & Content Choices:
                 1. Calendar Grid: HTML Grid. Chosen for accessibility and ease of interaction (click targets) over a Canvas chart.
                 2. Cycle Trends: Chart.js Bar Chart. Chosen to satisfy the "Analyze Source Report" need for visualizations. It shows Cycle Length variation.
                 3. Status Pill: Dynamic text in header. Immediate context for the user.
                 4. Interactions: Modal for logging prevents navigating away, keeping the context of the calendar visible.
            -->
        </div>

        <!-- VIEW 2: BLUEPRINT (The Specification) -->
        <div id="view-blueprint" class="hidden space-y-6">
            
            <div class="bg-brand-50 border border-brand-100 p-4 rounded-xl">
                <h2 class="text-lg font-bold text-brand-900 mb-2">Project Specification Review</h2>
                <p class="text-sm text-brand-800 leading-relaxed">
                    This view outlines the technical architecture and scope defined in the source document. It serves as a guide for development and feature verification.
                </p>
            </div>

            <!-- Architecture Cards -->
            <section>
                <h3 class="text-sm uppercase tracking-wide text-neutral-500 font-bold mb-3">Architecture & Tech Stack</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-white p-4 rounded-xl border border-neutral-100 shadow-sm">
                        <div class="text-2xl mb-2">üì±</div>
                        <h4 class="font-bold text-neutral-800">Local-First PWA</h4>
                        <p class="text-xs text-neutral-500 mt-1">Privacy-centric. No servers. Data lives in `localStorage`. Offline capable via Service Worker.</p>
                    </div>
                    <div class="bg-white p-4 rounded-xl border border-neutral-100 shadow-sm">
                        <div class="text-2xl mb-2">‚ö°</div>
                        <h4 class="font-bold text-neutral-800">Tech Choice</h4>
                        <p class="text-xs text-neutral-500 mt-1">HTML5 + Tailwind CSS + Vanilla JS. Lightweight and fast for MVP.</p>
                    </div>
                </div>
            </section>

            <!-- Scope (MoSCoW) Interactive List -->
            <section>
                <h3 class="text-sm uppercase tracking-wide text-neutral-500 font-bold mb-3">Feature Scope (MoSCoW)</h3>
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-neutral-100 bg-neutral-50">
                        <h4 class="font-bold text-neutral-800">Must Have (The Skeleton)</h4>
                    </div>
                    <ul class="divide-y divide-neutral-100 text-sm">
                        <li class="p-4 flex items-start gap-3">
                            <span class="text-green-500 mt-0.5">‚úî</span>
                            <div>
                                <strong class="block text-neutral-800">Calendar View</strong>
                                <span class="text-neutral-500">Monthly view with visual indicators for Period and Predictions.</span>
                            </div>
                        </li>
                        <li class="p-4 flex items-start gap-3">
                            <span class="text-green-500 mt-0.5">‚úî</span>
                            <div>
                                <strong class="block text-neutral-800">Daily Logging</strong>
                                <span class="text-neutral-500">Flow, Symptoms, and Mood tracking via modal.</span>
                            </div>
                        </li>
                        <li class="p-4 flex items-start gap-3">
                            <span class="text-green-500 mt-0.5">‚úî</span>
                            <div>
                                <strong class="block text-neutral-800">Persistence</strong>
                                <span class="text-neutral-500">Immediate save to browser storage.</span>
                            </div>
                        </li>
                    </ul>
                </div>
                
                <div class="mt-4 bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-4 border-b border-neutral-100 bg-neutral-50">
                        <h4 class="font-bold text-neutral-800">Should Have & Future</h4>
                    </div>
                    <ul class="divide-y divide-neutral-100 text-sm">
                        <li class="p-4 flex items-start gap-3">
                            <span class="text-green-500 mt-0.5">‚úî</span>
                            <div>
                                <strong class="block text-neutral-800">Data Backup</strong>
                                <span class="text-neutral-500">Export/Import JSON functionality (Implemented in Settings).</span>
                            </div>
                        </li>
                        <li class="p-4 flex items-start gap-3">
                            <span class="text-neutral-300 mt-0.5">‚óã</span>
                            <div>
                                <strong class="block text-neutral-400">Cloud Sync (Future)</strong>
                                <span class="text-neutral-400">Firebase migration for multi-device support.</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </section>
        </div>

        <!-- VIEW 3: SETTINGS (Data Management) -->
        <div id="view-settings" class="hidden space-y-6">
            
            <div class="bg-white p-4 rounded-xl shadow-sm border border-neutral-100">
                <p class="text-sm text-neutral-600 leading-relaxed">
                    <strong>Data Control:</strong> As a Local-First application, your data resides entirely on this device. Use the tools below to backup or transfer your history.
                </p>
            </div>

            <!-- Data Actions -->
            <div class="bg-white rounded-xl shadow-sm p-4 space-y-4">
                <h3 class="font-bold text-neutral-800 mb-2">Data Management</h3>
                
                <button onclick="app.exportData()" class="w-full flex items-center justify-between p-3 bg-brand-50 hover:bg-brand-100 text-brand-700 rounded-lg transition-colors">
                    <span class="flex items-center gap-2"><span>üì•</span> Export Backup (JSON)</span>
                    <span class="text-lg">‚Ä∫</span>
                </button>

                <div class="relative w-full">
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="app.importData(this)">
                    <button onclick="document.getElementById('importFile').click()" class="w-full flex items-center justify-between p-3 bg-neutral-50 hover:bg-neutral-100 text-neutral-700 rounded-lg transition-colors">
                        <span class="flex items-center gap-2"><span>üì§</span> Import Backup</span>
                        <span class="text-lg">‚Ä∫</span>
                    </button>
                </div>
                
                <hr class="border-neutral-100">

                <button onclick="app.clearData()" class="w-full flex items-center justify-between p-3 bg-white border border-red-100 hover:bg-red-50 text-red-600 rounded-lg transition-colors">
                    <span class="flex items-center gap-2"><span>üóëÔ∏è</span> Clear All Data</span>
                </button>
            </div>

            <!-- Debug View (JSON) -->
            <div class="bg-neutral-800 rounded-xl shadow-sm p-4">
                <h3 class="font-bold text-neutral-200 mb-2 text-xs uppercase tracking-wider">Current Data Structure</h3>
                <pre id="json-viewer" class="text-xs text-green-400 font-mono overflow-x-auto p-2 bg-neutral-900 rounded-lg">
                    <!-- Data dump here -->
                </pre>
            </div>
        </div>

    </main>

    <!-- Logging Modal (Hidden by default) -->
    <div id="log-modal" class="fixed inset-0 bg-neutral-900/50 z-50 hidden flex items-end sm:items-center sm:justify-center backdrop-blur-sm transition-opacity opacity-0 pointer-events-none">
        <div class="bg-white w-full sm:w-96 sm:rounded-2xl rounded-t-2xl shadow-2xl transform transition-transform translate-y-full sm:translate-y-0 p-5 max-h-[90vh] overflow-y-auto">
            
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-neutral-800">Log Entry</h2>
                    <p id="modal-date-label" class="text-sm text-neutral-500">Today</p>
                </div>
                <button onclick="app.closeModal()" class="w-8 h-8 rounded-full bg-neutral-100 text-neutral-500 flex items-center justify-center">‚úï</button>
            </div>

            <!-- Form -->
            <div class="space-y-6">
                
                <!-- Flow -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-neutral-500 uppercase tracking-wide">Flow Intensity</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button class="flow-btn p-2 rounded-lg border border-neutral-200 text-center text-sm hover:bg-brand-50 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all" data-value="spotting">
                            <span class="block text-lg mb-1">üíß</span>
                            Spot
                        </button>
                        <button class="flow-btn p-2 rounded-lg border border-neutral-200 text-center text-sm hover:bg-brand-50 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all" data-value="light">
                            <span class="block text-lg mb-1">üíßüíß</span>
                            Light
                        </button>
                        <button class="flow-btn p-2 rounded-lg border border-neutral-200 text-center text-sm hover:bg-brand-50 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all" data-value="medium">
                            <span class="block text-lg mb-1">ü©∏</span>
                            Med
                        </button>
                        <button class="flow-btn p-2 rounded-lg border border-neutral-200 text-center text-sm hover:bg-brand-50 focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all" data-value="heavy">
                            <span class="block text-lg mb-1">üåä</span>
                            Heavy
                        </button>
                    </div>
                </div>

                <!-- Mood -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-neutral-500 uppercase tracking-wide">Mood</label>
                    <div class="flex justify-between bg-neutral-50 p-2 rounded-xl">
                        <button class="mood-btn text-2xl p-2 rounded-full hover:bg-white transition-colors opacity-50 hover:opacity-100 focus:opacity-100" data-value="happy">üòä</button>
                        <button class="mood-btn text-2xl p-2 rounded-full hover:bg-white transition-colors opacity-50 hover:opacity-100 focus:opacity-100" data-value="neutral">üòê</button>
                        <button class="mood-btn text-2xl p-2 rounded-full hover:bg-white transition-colors opacity-50 hover:opacity-100 focus:opacity-100" data-value="sad">üò¢</button>
                        <button class="mood-btn text-2xl p-2 rounded-full hover:bg-white transition-colors opacity-50 hover:opacity-100 focus:opacity-100" data-value="irritable">üò†</button>
                        <button class="mood-btn text-2xl p-2 rounded-full hover:bg-white transition-colors opacity-50 hover:opacity-100 focus:opacity-100" data-value="tired">üò¥</button>
                    </div>
                </div>

                <!-- Symptoms -->
                <div class="space-y-2">
                    <label class="text-xs font-bold text-neutral-500 uppercase tracking-wide">Symptoms</label>
                    <div class="flex flex-wrap gap-2" id="symptom-chips">
                        <!-- JS generated -->
                    </div>
                </div>

                <!-- Save Action -->
                <button onclick="app.saveEntry()" class="w-full py-3 bg-brand-500 text-white rounded-xl font-bold shadow-md active:scale-95 transition-transform">
                    Save Entry
                </button>
                <button onclick="app.deleteEntry()" class="w-full py-2 text-red-400 text-sm hover:text-red-600">
                    Delete Entry
                </button>

            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 w-full bg-white border-t border-neutral-200 pb-safe z-40">
        <div class="flex justify-around items-center h-16 max-w-lg mx-auto">
            <button class="nav-btn active flex flex-col items-center justify-center w-full h-full text-brand-500" data-target="view-prototype">
                <span class="text-2xl mb-0.5">üìÖ</span>
                <span class="text-[10px] font-medium">Tracker</span>
            </button>
            <button class="nav-btn flex flex-col items-center justify-center w-full h-full text-neutral-400 hover:text-neutral-600 transition-colors" data-target="view-blueprint">
                <span class="text-2xl mb-0.5">üìã</span>
                <span class="text-[10px] font-medium">Spec</span>
            </button>
            <button class="nav-btn flex flex-col items-center justify-center w-full h-full text-neutral-400 hover:text-neutral-600 transition-colors" data-target="view-settings">
                <span class="text-2xl mb-0.5">‚öôÔ∏è</span>
                <span class="text-[10px] font-medium">Data</span>
            </button>
        </div>
    </nav>

    <!-- Logic -->
    <script>
        // --- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. ---
        
        const app = {
            data: {
                userSettings: {
                    averageCycleLength: 28,
                    customSymptoms: ["Cramps", "Headache", "Bloating", "Acne", "Cravings", "Backache"]
                },
                entries: {} // Format: "YYYY-MM-DD": { flow: 'medium', mood: 'happy', symptoms: [] }
            },
            state: {
                currentDate: new Date(), // For calendar navigation
                selectedDateStr: null,   // For modal
                view: 'view-prototype'
            },
            chartInstance: null,

            init() {
                // Load from LocalStorage
                const saved = localStorage.getItem('cycle_tracker_mvp_data');
                if (saved) {
                    try {
                        this.data = JSON.parse(saved);
                    } catch(e) { console.error("Data load error", e); }
                }

                // Setup Nav Listeners
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchView(e.currentTarget.dataset.target, e.currentTarget);
                    });
                });

                // Setup Calendar Nav
                document.getElementById('prev-month').addEventListener('click', () => {
                    this.state.currentDate.setMonth(this.state.currentDate.getMonth() - 1);
                    this.renderCalendar();
                });
                document.getElementById('next-month').addEventListener('click', () => {
                    this.state.currentDate.setMonth(this.state.currentDate.getMonth() + 1);
                    this.renderCalendar();
                });

                // Setup Symptom Chips
                this.renderSymptomChips();

                // Initial Render
                this.renderCalendar();
                this.updateStats();
                this.renderJSONViewer();
            },

            switchView(viewId, btnElement) {
                // Hide all views
                ['view-prototype', 'view-blueprint', 'view-settings'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                // Show target
                document.getElementById(viewId).classList.remove('hidden');
                
                // Update Nav UI
                document.querySelectorAll('.nav-btn').forEach(b => {
                    b.classList.remove('text-brand-500');
                    b.classList.add('text-neutral-400');
                });
                btnElement.classList.remove('text-neutral-400');
                btnElement.classList.add('text-brand-500');

                this.state.view = viewId;
                if(viewId === 'view-settings') this.renderJSONViewer();
                if(viewId === 'view-prototype') this.updateStats();
            },

            saveData() {
                localStorage.setItem('cycle_tracker_mvp_data', JSON.stringify(this.data));
                this.renderJSONViewer();
            },

            // --- Calendar Logic ---

            renderCalendar() {
                const grid = document.getElementById('calendar-grid');
                grid.innerHTML = '';
                
                const year = this.state.currentDate.getFullYear();
                const month = this.state.currentDate.getMonth();
                
                // Update Label
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                document.getElementById('current-month-label').textContent = `${monthNames[month]} ${year}`;

                // Calculate geometry
                const firstDay = new Date(year, month, 1).getDay(); // 0 = Sunday
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                // Predictions
                const predictions = this.calculatePredictions();

                // Empty slots for start
                for (let i = 0; i < firstDay; i++) {
                    const empty = document.createElement('div');
                    grid.appendChild(empty);
                }

                // Days
                const todayStr = new Date().toISOString().split('T')[0];

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const entry = this.data.entries[dateStr];
                    const isToday = dateStr === todayStr;
                    
                    const dayEl = document.createElement('div');
                    dayEl.className = `aspect-square rounded-full flex flex-col items-center justify-center text-sm cursor-pointer relative hover:bg-neutral-100 transition-colors ${isToday ? 'bg-neutral-100 font-bold border border-neutral-300' : ''}`;
                    dayEl.onclick = () => this.openLog(dateStr);

                    // Day Number
                    const numSpan = document.createElement('span');
                    numSpan.textContent = d;
                    numSpan.className = "z-10";
                    dayEl.appendChild(numSpan);

                    // Indicators
                    if (entry && entry.flow) {
                        dayEl.classList.add('bg-brand-500', 'text-white', 'hover:bg-brand-600');
                        if (isToday) dayEl.classList.remove('bg-neutral-100', 'text-neutral-800'); // Override today style if logged
                    } else if (predictions.includes(dateStr)) {
                        dayEl.classList.add('bg-brand-50', 'text-brand-800', 'border', 'border-brand-200', 'border-dashed');
                    }

                    // Mood Dot
                    if (entry && entry.mood) {
                        const dot = document.createElement('span');
                        dot.className = "absolute bottom-1 w-1 h-1 rounded-full bg-yellow-400";
                        dayEl.appendChild(dot);
                    }

                    grid.appendChild(dayEl);
                }
            },

            // --- Prediction Engine (Section 3 Must Have) ---
            calculatePredictions() {
                // Find all cycle start dates
                const dates = Object.keys(this.data.entries).sort();
                const starts = [];
                let lastDate = null;

                dates.forEach(d => {
                    const entry = this.data.entries[d];
                    if (!entry.flow) return;
                    
                    const dateObj = new Date(d);
                    // Determine if this is a new cycle start (gap > 10 days from last log)
                    if (!lastDate || (dateObj - lastDate) / (1000 * 60 * 60 * 24) > 10) {
                        starts.push(d);
                    }
                    lastDate = dateObj;
                });

                if (starts.length === 0) return [];

                // Calculate Average Cycle Length
                let totalDiff = 0;
                let count = 0;
                if (starts.length >= 2) {
                    for(let i=1; i<starts.length; i++) {
                        const diff = (new Date(starts[i]) - new Date(starts[i-1])) / (1000*60*60*24);
                        if (diff < 40 && diff > 20) { // Sanity check
                            totalDiff += diff;
                            count++;
                        }
                    }
                }
                
                const avg = count > 0 ? Math.round(totalDiff / count) : this.data.userSettings.averageCycleLength;
                
                // Predict next 3 months
                const lastStart = new Date(starts[starts.length - 1]);
                const predictionDates = [];
                
                // Next cycle start
                const nextStart = new Date(lastStart);
                nextStart.setDate(lastStart.getDate() + avg);
                
                // Add 5 days of prediction
                for(let i=0; i<5; i++) {
                    const pDate = new Date(nextStart);
                    pDate.setDate(nextStart.getDate() + i);
                    predictionDates.push(pDate.toISOString().split('T')[0]);
                }

                // Header status update
                const daysUntil = Math.ceil((nextStart - new Date()) / (1000*60*60*24));
                const statusEl = document.getElementById('status-indicator');
                if (daysUntil > 0) statusEl.textContent = `Period in ~${daysUntil} days`;
                else if (daysUntil > -7 && daysUntil <= 0) statusEl.textContent = "Period likely now";
                else statusEl.textContent = "Log to see predictions";

                return predictionDates;
            },

            // --- Modal Logic ---

            openLog(dateStr) {
                this.state.selectedDateStr = dateStr;
                const modal = document.getElementById('log-modal');
                const entry = this.data.entries[dateStr] || {};

                // UI Reset
                document.getElementById('modal-date-label').textContent = new Date(dateStr).toDateString();
                
                // Select Flow
                document.querySelectorAll('.flow-btn').forEach(b => {
                    b.classList.remove('ring-2', 'ring-brand-500', 'border-brand-500', 'bg-brand-50');
                    if (b.dataset.value === entry.flow) {
                        b.classList.add('ring-2', 'ring-brand-500', 'border-brand-500', 'bg-brand-50');
                    }
                });

                // Select Mood
                document.querySelectorAll('.mood-btn').forEach(b => {
                    b.classList.remove('opacity-100', 'bg-white', 'shadow-sm');
                    b.classList.add('opacity-50');
                    if (b.dataset.value === entry.mood) {
                        b.classList.remove('opacity-50');
                        b.classList.add('opacity-100', 'bg-white', 'shadow-sm');
                    }
                });

                // Select Symptoms
                document.querySelectorAll('.symptom-chip').forEach(c => {
                    c.classList.remove('bg-neutral-800', 'text-white');
                    c.classList.add('bg-neutral-100', 'text-neutral-600');
                    if (entry.symptoms && entry.symptoms.includes(c.dataset.value)) {
                        c.classList.remove('bg-neutral-100', 'text-neutral-600');
                        c.classList.add('bg-neutral-800', 'text-white');
                    }
                });

                // Show
                modal.classList.remove('hidden', 'pointer-events-none');
                setTimeout(() => modal.classList.remove('opacity-0'), 10);
            },

            closeModal() {
                const modal = document.getElementById('log-modal');
                modal.classList.add('opacity-0');
                setTimeout(() => modal.classList.add('hidden', 'pointer-events-none'), 300);
            },

            saveEntry() {
                const flowBtn = document.querySelector('.flow-btn.ring-2');
                const moodBtn = document.querySelector('.mood-btn.opacity-100');
                const symptomChips = document.querySelectorAll('.symptom-chip.bg-neutral-800');
                
                const symptoms = Array.from(symptomChips).map(c => c.dataset.value);
                const flow = flowBtn ? flowBtn.dataset.value : null;
                const mood = moodBtn ? moodBtn.dataset.value : null;

                if (!flow && !mood && symptoms.length === 0) {
                    // Empty entry, do nothing or delete
                    delete this.data.entries[this.state.selectedDateStr];
                } else {
                    this.data.entries[this.state.selectedDateStr] = { flow, mood, symptoms };
                }

                this.saveData();
                this.closeModal();
                this.renderCalendar();
                this.updateStats();
            },

            deleteEntry() {
                delete this.data.entries[this.state.selectedDateStr];
                this.saveData();
                this.closeModal();
                this.renderCalendar();
                this.updateStats();
            },

            // --- UI Helpers ---

            renderSymptomChips() {
                const container = document.getElementById('symptom-chips');
                container.innerHTML = '';
                this.data.userSettings.customSymptoms.forEach(sym => {
                    const btn = document.createElement('button');
                    btn.className = "symptom-chip px-3 py-1.5 rounded-full text-xs font-medium bg-neutral-100 text-neutral-600 transition-colors border border-transparent";
                    btn.textContent = sym;
                    btn.dataset.value = sym;
                    btn.onclick = () => {
                        if (btn.classList.contains('bg-neutral-800')) {
                            btn.classList.remove('bg-neutral-800', 'text-white');
                            btn.classList.add('bg-neutral-100', 'text-neutral-600');
                        } else {
                            btn.classList.remove('bg-neutral-100', 'text-neutral-600');
                            btn.classList.add('bg-neutral-800', 'text-white');
                        }
                    };
                    container.appendChild(btn);
                });
            },

            setupFlowListeners() {
                document.querySelectorAll('.flow-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('.flow-btn').forEach(b => b.classList.remove('ring-2', 'ring-brand-500', 'border-brand-500', 'bg-brand-50'));
                        if (btn.classList.contains('ring-2')) {
                             // toggle off? No, standard radio behavior usually
                        } else {
                            btn.classList.add('ring-2', 'ring-brand-500', 'border-brand-500', 'bg-brand-50');
                        }
                    };
                });
                
                document.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.onclick = () => {
                        document.querySelectorAll('.mood-btn').forEach(b => {
                            b.classList.remove('opacity-100', 'bg-white', 'shadow-sm');
                            b.classList.add('opacity-50');
                        });
                        btn.classList.remove('opacity-50');
                        btn.classList.add('opacity-100', 'bg-white', 'shadow-sm');
                    }
                });
            },

            // --- Analytics ---
            updateStats() {
                // Calculate Cycle Lengths
                const dates = Object.keys(this.data.entries).sort();
                const starts = [];
                let lastDate = null;
                dates.forEach(d => {
                    const entry = this.data.entries[d];
                    if (!entry.flow) return;
                    const dateObj = new Date(d);
                    if (!lastDate || (dateObj - lastDate) / (1000 * 60 * 60 * 24) > 10) {
                        starts.push(d);
                    }
                    lastDate = dateObj;
                });

                const lengths = [];
                const labels = [];
                
                if (starts.length >= 2) {
                    for(let i=1; i<starts.length; i++) {
                        const diff = Math.round((new Date(starts[i]) - new Date(starts[i-1])) / (1000*60*60*24));
                        if(diff < 50) {
                            lengths.push(diff);
                            const m = new Date(starts[i-1]).toLocaleString('default', { month: 'short' });
                            labels.push(m);
                        }
                    }
                }

                // Render Chart
                const ctx = document.getElementById('cycleChart').getContext('2d');
                
                if (this.chartInstance) this.chartInstance.destroy();

                if (lengths.length === 0) {
                    // Placeholder data if empty
                    this.chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['No Data', 'Log', 'More', 'Cycles'],
                            datasets: [{
                                label: 'Cycle Length (Days)',
                                data: [28, 28, 28, 28],
                                backgroundColor: '#e7e5e4',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { y: { display: false }, x: { grid: { display: false } } }
                        }
                    });
                    return;
                }

                this.chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cycle Length',
                            data: lengths,
                            backgroundColor: '#fb7185',
                            borderRadius: 6,
                            maxBarThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => `${ctx.raw} Days`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 20,
                                grid: { color: '#f5f5f4' }
                            },
                            x: {
                                grid: { display: false }
                            }
                        }
                    }
                });
            },

            // --- Data Management (Settings) ---
            renderJSONViewer() {
                const viewer = document.getElementById('json-viewer');
                viewer.textContent = JSON.stringify(this.data, null, 2);
            },

            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.data));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "cycle_tracker_backup_" + new Date().toISOString().split('T')[0] + ".json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            },

            importData(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.entries) {
                            this.data = json;
                            this.saveData();
                            this.init(); // Re-init
                            alert('Data imported successfully!');
                        } else {
                            alert('Invalid file format.');
                        }
                    } catch (err) {
                        alert('Error parsing JSON.');
                    }
                };
                reader.readAsText(file);
            },

            clearData() {
                if(confirm("Are you sure? This will delete all history.")) {
                    this.data.entries = {};
                    this.saveData();
                    this.init();
                }
            }
        };

        // Initialize listeners
        app.setupFlowListeners();
        // Start App
        app.init();

    </script>
</body>
</html>
